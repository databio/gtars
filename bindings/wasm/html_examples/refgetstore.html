<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GTARS FASTA Processor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .file-input {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            text-align: center;
        }
        .loading {
            color: #856404;
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
            margin: 20px 0;
        }
        .results {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .digest-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .sequence-list {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .sequence-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .sequence-item:last-child {
            border-bottom: none;
        }
        button {
            padding: 10px 20px;
            margin: 10px 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #fff;
            padding: 15px;
            overflow-x: auto;
            border-radius: 4px;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üß¨ GTARS FASTA Processor</h1>

    <div class="file-input">
        <input type="file" id="fastaFile" accept=".fasta,.fa,.fas,.fna" />
        <p>üìÅ Select a FASTA file to process</p>
    </div>

    <div class="storage-controls">
        <h3>üíæ Storage Management</h3>
        <div class="storage-buttons">
            <button onclick="saveStoreToBrowser()" id="saveBtn" disabled>
                üíæ Save to Browser Storage
            </button>
            <button onclick="loadStoreFromBrowser()">
                üìÇ Load from Browser Storage
            </button>
            <button onclick="downloadStore()" id="downloadBtn" disabled>
                ‚¨áÔ∏è Download as File
            </button>
            <button onclick="loadStoreFromFile()">
                ‚¨ÜÔ∏è Upload Store File
            </button>
            <button onclick="clearBrowserStorage()">
                üóëÔ∏è Clear Stored Data
            </button>
        </div>
        <div id="storeInfo" class="store-info">
            <p>No RefGet store loaded</p>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        üîÑ Processing FASTA file and computing digests...
    </div>

    <div id="results" class="results" style="display: none;">
        <h3>üìä Results:</h3>
        <div id="output"></div>
    </div>
</div>

<script type="module">
    import init, { SequenceCollectionWasm,WasmRefgetStore } from '../pkg/gtars_js.js';
    let globalRefgetStore = null;
    async function run() {
        try {
            await init();
            console.log("‚úÖ WASM module loaded successfully");
            globalRefgetStore = new WasmRefgetStore();

            document.getElementById('fastaFile').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                console.log("THERE IS A FILE PRESENT!");

                document.getElementById('loading').style.display = 'block';
                document.getElementById('results').style.display = 'none';

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);

                    const seqCollection = SequenceCollectionWasm.from_fasta_bytes(uint8Array);
                    console.log("‚úÖ SequenceCollectionWasm object loaded successfully:", seqCollection);
                    console.log("üìà Sequence Count:", seqCollection.sequence_count);
                    console.log("üîê Collection Digest:", seqCollection.digest);

                    document.getElementById('loading').style.display = 'none';
                    displayResults(seqCollection, file.name);

                    globalRefgetStore.add_fasta(uint8Array);
                    console.log("‚úÖ FASTA data added to global store.");

                } catch (error) {
                    console.error('‚ùå Error processing FASTA file:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('output').innerHTML = `
                        <div class="error">
                            <h4>Error Processing File</h4>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p><strong>File:</strong> ${file.name}</p>
                        </div>
                    `;
                }
            });

        } catch (error) {
            console.error('‚ùå Failed to initialize WASM module:', error);
            document.body.innerHTML = `
                <div class="container">
                    <div class="error">
                        <h2>Failed to Load WASM Module</h2>
                        <p>Error: ${error.message}</p>
                        <p>Please ensure the WASM files are built and available.</p>
                    </div>
                </div>
            `;
        }
    }
    // Storage management functions
    window.saveStoreToBrowser = async function() {
        try {

            if (globalRefgetStore.get_sequence_count() === 0) {
                alert('‚ùå No data to save!');
                return;
            }
            await globalRefgetStore.save_to_browser_storage('gtars_refget_store');
            alert('‚úÖ RefGet store saved to browser storage!');
        } catch (error) {
            alert('‚ùå Failed to save: ' + error);
        }
    };


    function displayResults(seqCollection, fileName) {
        document.getElementById('results').style.display = 'block';

        try {
            // Use the WASM getter methods
            const digest = seqCollection.digest;
            const sequences = seqCollection.sequences || [];
            //const lvl1 = seqCollection.lvl1 || {};
            const sequenceCount = seqCollection.sequence_count;

            // Calculate statistics
            const totalLength = sequences.reduce((sum, seq) => {
                return sum + (seq.metadata?.length || 0);
            }, 0);

            // Create statistics display
            const statsHtml = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value">${sequenceCount}</div>
                        <div class="stat-label">Sequences</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalLength.toLocaleString()}</div>
                        <div class="stat-label">Total Base Pairs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(totalLength / 1000000).toFixed(1)}M</div>
                        <div class="stat-label">Megabases</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(new File([new ArrayBuffer(0)], fileName).size || 0)}</div>
                        <div class="stat-label">File Size (bytes)</div>
                    </div>
                </div>
            `;

            // Create digest information
            const digestHtml = `
                <div class="digest-info">
                    <h4>üîê RefGet Collection Digest</h4>
                    <p><strong>Collection Digest:</strong> <code>${digest}</code></p>
                </div>
            `;

            // Create sequence list (show first 10)
            const maxShow = 10;
            const sequencesToShow = sequences.slice(0, maxShow);
            const sequencesHtml = `
                <div class="sequence-list">
                    <h4>üìã Sequences ${sequences.length > maxShow ? `(showing first ${maxShow} of ${sequences.length})` : ''}</h4>
                    ${sequencesToShow.map((seq, index) => `
                        <div class="sequence-item">
                            <strong>${seq.metadata?.name || `Sequence ${index + 1}`}</strong><br>
                            <small>
                                Length: ${(seq.metadata?.length || 0).toLocaleString()} bp |
                                Alphabet: ${seq.metadata?.alphabet || 'unknown'} |
                                SHA512t24u: <code>${(seq.metadata?.sha512t24u || 'N/A').substring(0, 20)}...</code>
                            </small>
                        </div>
                    `).join('')}
                    ${sequences.length > maxShow ? `
                        <div style="text-align: center; padding: 10px;">
                            <button onclick="showAllSequences()" id="showAllBtn">
                                Show All ${sequences.length} Sequences
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            // Raw data section
            const rawDataHtml = `
                <details>
                    <summary>üîç Raw Data (JSON)</summary>
                    <pre>${JSON.stringify({
                file_name: fileName,
                digest: digest,
                sequence_count: sequenceCount,
                total_length: totalLength,
                sequences: sequences.map(seq => ({
                    name: seq.metadata?.name,
                    length: seq.metadata?.length,
                    alphabet: seq.metadata?.alphabet,
                    sha512t24u: seq.metadata?.sha512t24u,
                    md5: seq.metadata?.md5
                }))
            }, null, 2)}</pre>
                </details>
            `;

            // Display everything
            document.getElementById('output').innerHTML = `
                <h4>üìÅ File: ${fileName}</h4>
                ${statsHtml}
                ${digestHtml}
                ${sequencesHtml}
                ${rawDataHtml}
            `;

            // Store sequences globally for the "show all" function
            window.allSequences = sequences;

        } catch (error) {
            console.error('Error displaying results:', error);
            document.getElementById('output').innerHTML = `
                <div class="error">
                    <h4>Error Displaying Results</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>
            `;
        }
    }

    // Function to show all sequences
    window.showAllSequences = function() {
        const sequences = window.allSequences || [];
        const sequenceListDiv = document.querySelector('.sequence-list');

        sequenceListDiv.innerHTML = `
            <h4>üìã All Sequences (${sequences.length})</h4>
            ${sequences.map((seq, index) => `
                <div class="sequence-item">
                    <strong>${seq.metadata?.name || `Sequence ${index + 1}`}</strong><br>
                    <small>
                        Length: ${(seq.metadata?.length || 0).toLocaleString()} bp |
                        Alphabet: ${seq.metadata?.alphabet || 'unknown'} |
                        SHA512t24u: <code>${seq.metadata?.sha512t24u || 'N/A'}</code>
                    </small>
                </div>
            `).join('')}
        `;
    };

    run().catch(console.error);
</script>
</body>
</html>